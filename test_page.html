<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page with Sankey Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .layer {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <h1>Test Page for SankeyStone Extension</h1>
    <p>This page contains sample Sankey diagram data for testing the extension's refresh functionality.</p>

    <!-- JSON Data Method -->
    <h2>Method 1: JSON Data in Script Tag</h2>
    <div id="current-context-info" style="background: #f0f8ff; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; font-weight: bold;">
        Current Context: <span id="context-name">Loading...</span>
    </div>
    <script type="application/json" id="sankey-data">
    {"placeholder": "data will be generated by JavaScript"}
    </script>

    <!-- Table Data Method -->
    <h2>Method 2: Table Data with Sankey Attributes</h2>
    
    <div class="layer">
        <h3>Layer 0: Traffic Sources</h3>
        <table data-sankey-layer="0">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Traffic Volume</th>
                </tr>
            </thead>
            <tbody>
                <tr data-node-id="0">
                    <td>Direct Traffic</td>
                    <td>4,500</td>
                </tr>
                <tr data-node-id="1">
                    <td>Social Media</td>
                    <td>2,000</td>
                </tr>
                <tr data-node-id="2">
                    <td>Email Marketing</td>
                    <td>1,000</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="layer">
        <h3>Layer 1: Page Categories</h3>
        <table data-sankey-layer="1">
            <thead>
                <tr>
                    <th>Page Type</th>
                    <th>Visits</th>
                </tr>
            </thead>
            <tbody>
                <tr data-node-id="3">
                    <td>Product Pages</td>
                    <td>4,300</td>
                </tr>
                <tr data-node-id="4">
                    <td>Blog Content</td>
                    <td>2,600</td>
                </tr>
                <tr data-node-id="5">
                    <td>Support Pages</td>
                    <td>600</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="layer">
        <h3>Layer 2: Outcomes</h3>
        <table data-sankey-layer="2">
            <thead>
                <tr>
                    <th>Outcome</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                <tr data-node-id="6">
                    <td>Conversion</td>
                    <td>1,100</td>
                </tr>
                <tr data-node-id="7">
                    <td>Newsletter Signup</td>
                    <td>1,050</td>
                </tr>
                <tr data-node-id="8">
                    <td>Bounce</td>
                    <td>5,350</td>
                </tr>
            </tbody>
        </table>
    </div>

    <p><strong>Instructions:</strong></p>
    <ul>
        <li>ðŸ”„ <strong>Extension Refresh:</strong> Open the SankeyStone extension and click "ðŸ”„ Refresh from Page" to extract current data</li>
        <li>ðŸŽ² <strong>New Context:</strong> Click "Generate New Context" above or refresh the page to get different business scenarios</li>
        <li>ðŸŽ¯ <strong>Context Detection:</strong> Watch how the extension generates different titles for different business contexts</li>
        <li>ðŸ“Š <strong>Dynamic Data:</strong> Each context has realistic flow patterns and volumes for that industry</li>
    </ul>
    
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h4>ðŸ§ª Testing Different Contexts:</h4>
        <p>This page randomly generates data for different business contexts like:</p>
        <ul style="columns: 2; margin: 10px 0;">
            <li>E-commerce Customer Journey</li>
            <li>SaaS User Onboarding</li>
            <li>Healthcare Patient Flow</li>
            <li>Education Enrollment</li>
            <li>Marketing Campaigns</li>
            <li>Banking Customer Journey</li>
            <li>Retail Store Experience</li>
            <li>Content Engagement Flow</li>
        </ul>
        <p><strong>Try this:</strong> Generate a few different contexts and refresh the extension each time to see how the titles and data change!</p>
    </div>
    
    <script>
        // Different business contexts with their specific nodes and relationships
        const contextTemplates = {
            ecommerce: {
                name: "E-commerce Customer Journey",
                nodes: [
                    {"id": 0, "name": "Organic Search", "layer": 0},
                    {"id": 1, "name": "Paid Ads", "layer": 0},
                    {"id": 2, "name": "Social Media", "layer": 0},
                    {"id": 3, "name": "Product Catalog", "layer": 1},
                    {"id": 4, "name": "Product Details", "layer": 1},
                    {"id": 5, "name": "Shopping Cart", "layer": 1},
                    {"id": 6, "name": "Purchase Complete", "layer": 2},
                    {"id": 7, "name": "Abandoned Cart", "layer": 2},
                    {"id": 8, "name": "Browse Exit", "layer": 2}
                ],
                baseVolumes: { layer0: [3000, 2500, 1500], layer1: [2800, 2200, 2000], layer2: [1200, 1800, 4000] }
            },
            
            saas: {
                name: "SaaS User Onboarding Flow", 
                nodes: [
                    {"id": 0, "name": "Free Trial Signup", "layer": 0},
                    {"id": 1, "name": "Demo Request", "layer": 0},
                    {"id": 2, "name": "Direct Signup", "layer": 0},
                    {"id": 3, "name": "Feature Tour", "layer": 1},
                    {"id": 4, "name": "Dashboard Usage", "layer": 1},
                    {"id": 5, "name": "Integration Setup", "layer": 1},
                    {"id": 6, "name": "Paid Subscription", "layer": 2},
                    {"id": 7, "name": "Extended Trial", "layer": 2},
                    {"id": 8, "name": "Churned", "layer": 2}
                ],
                baseVolumes: { layer0: [1200, 800, 600], layer1: [900, 800, 700], layer2: [450, 350, 1600] }
            },
            
            healthcare: {
                name: "Patient Care Pathway",
                nodes: [
                    {"id": 0, "name": "Online Appointment", "layer": 0},
                    {"id": 1, "name": "Walk-in Patient", "layer": 0},
                    {"id": 2, "name": "Referral", "layer": 0},
                    {"id": 3, "name": "Initial Consultation", "layer": 1},
                    {"id": 4, "name": "Diagnostic Tests", "layer": 1},
                    {"id": 5, "name": "Specialist Referral", "layer": 1},
                    {"id": 6, "name": "Treatment Complete", "layer": 2},
                    {"id": 7, "name": "Follow-up Scheduled", "layer": 2},
                    {"id": 8, "name": "No Further Care", "layer": 2}
                ],
                baseVolumes: { layer0: [800, 400, 300], layer1: [600, 500, 400], layer2: [450, 550, 500] }
            },
            
            education: {
                name: "Student Enrollment Journey",
                nodes: [
                    {"id": 0, "name": "Course Inquiry", "layer": 0},
                    {"id": 1, "name": "Campus Visit", "layer": 0},
                    {"id": 2, "name": "Online Research", "layer": 0},
                    {"id": 3, "name": "Application Submitted", "layer": 1},
                    {"id": 4, "name": "Financial Aid Review", "layer": 1},
                    {"id": 5, "name": "Course Selection", "layer": 1},
                    {"id": 6, "name": "Enrolled Student", "layer": 2},
                    {"id": 7, "name": "Deferred Enrollment", "layer": 2},
                    {"id": 8, "name": "Application Withdrawn", "layer": 2}
                ],
                baseVolumes: { layer0: [2200, 1500, 3000], layer1: [2800, 1900, 2000], layer2: [1800, 600, 2400] }
            },
            
            marketing: {
                name: "Lead Generation Campaign",
                nodes: [
                    {"id": 0, "name": "Email Campaign", "layer": 0},
                    {"id": 1, "name": "Content Marketing", "layer": 0},
                    {"id": 2, "name": "Paid Advertising", "layer": 0},
                    {"id": 3, "name": "Landing Page Visit", "layer": 1},
                    {"id": 4, "name": "Whitepaper Download", "layer": 1},
                    {"id": 5, "name": "Webinar Signup", "layer": 1},
                    {"id": 6, "name": "Qualified Lead", "layer": 2},
                    {"id": 7, "name": "Newsletter Subscriber", "layer": 2},
                    {"id": 8, "name": "Unsubscribed", "layer": 2}
                ],
                baseVolumes: { layer0: [4000, 3500, 2800], layer1: [3200, 2900, 2700], layer2: [2100, 3400, 2300] }
            },
            
            finance: {
                name: "Banking Customer Journey",
                nodes: [
                    {"id": 0, "name": "Online Banking", "layer": 0},
                    {"id": 1, "name": "Branch Visit", "layer": 0},
                    {"id": 2, "name": "Mobile App", "layer": 0},
                    {"id": 3, "name": "Account Opening", "layer": 1},
                    {"id": 4, "name": "Loan Application", "layer": 1},
                    {"id": 5, "name": "Investment Consultation", "layer": 1},
                    {"id": 6, "name": "Account Approved", "layer": 2},
                    {"id": 7, "name": "Application Pending", "layer": 2},
                    {"id": 8, "name": "Application Declined", "layer": 2}
                ],
                baseVolumes: { layer0: [1800, 1200, 2200], layer1: [1900, 1600, 700], layer2: [2900, 800, 500] }
            },
            
            retail: {
                name: "In-Store Customer Experience",
                nodes: [
                    {"id": 0, "name": "Store Entrance", "layer": 0},
                    {"id": 1, "name": "Online Pickup", "layer": 0},
                    {"id": 2, "name": "Customer Service", "layer": 0},
                    {"id": 3, "name": "Browse Products", "layer": 1},
                    {"id": 4, "name": "Staff Assistance", "layer": 1},
                    {"id": 5, "name": "Fitting Room", "layer": 1},
                    {"id": 6, "name": "Purchase Made", "layer": 2},
                    {"id": 7, "name": "Item Return", "layer": 2},
                    {"id": 8, "name": "Left Without Purchase", "layer": 2}
                ],
                baseVolumes: { layer0: [5000, 800, 400], layer1: [2800, 1500, 1200], layer2: [2200, 400, 2900] }
            },
            
            media: {
                name: "Content Engagement Flow",
                nodes: [
                    {"id": 0, "name": "Article Readers", "layer": 0},
                    {"id": 1, "name": "Video Viewers", "layer": 0},
                    {"id": 2, "name": "Podcast Listeners", "layer": 0},
                    {"id": 3, "name": "Content Shared", "layer": 1},
                    {"id": 4, "name": "Comments Posted", "layer": 1},
                    {"id": 5, "name": "Profile Followed", "layer": 1},
                    {"id": 6, "name": "Subscribed", "layer": 2},
                    {"id": 7, "name": "Casual Engagement", "layer": 2},
                    {"id": 8, "name": "Bounced", "layer": 2}
                ],
                baseVolumes: { layer0: [8000, 6000, 2000], layer1: [4200, 3800, 1600], layer2: [2800, 3200, 9600] }
            }
        };
        
        // Function to generate random values with some variance
        function addVariance(baseValue, variancePercent = 25) {
            const variance = baseValue * (variancePercent / 100);
            const randomFactor = (Math.random() - 0.5) * 2; // -1 to +1
            return Math.max(50, Math.round(baseValue + (variance * randomFactor)));
        }
        
        // Function to generate proportional links between layers
        function generateLinks(nodes, baseVolumes) {
            const links = [];
            
            // Get nodes by layer
            const layer0 = nodes.filter(n => n.layer === 0);
            const layer1 = nodes.filter(n => n.layer === 1);
            const layer2 = nodes.filter(n => n.layer === 2);
            
            // Generate Layer 0 -> Layer 1 links
            layer0.forEach((sourceNode, sourceIndex) => {
                const sourceValue = baseVolumes.layer0[sourceIndex];
                let remainingValue = addVariance(sourceValue);
                
                layer1.forEach((targetNode, targetIndex) => {
                    // Distribute proportionally with some randomness
                    const baseProportion = 1 / layer1.length;
                    const randomFactor = 0.5 + Math.random(); // 0.5 to 1.5
                    const proportion = baseProportion * randomFactor;
                    
                    let linkValue;
                    if (targetIndex === layer1.length - 1) {
                        // Last link gets remainder
                        linkValue = Math.max(10, remainingValue);
                    } else {
                        linkValue = Math.round(remainingValue * proportion);
                        remainingValue -= linkValue;
                    }
                    
                    if (linkValue > 0) {
                        links.push({
                            source: sourceNode.id,
                            target: targetNode.id,
                            value: linkValue
                        });
                    }
                });
            });
            
            // Calculate actual Layer 1 totals based on incoming links
            const layer1Totals = {};
            layer1.forEach(node => {
                layer1Totals[node.id] = links
                    .filter(l => l.target === node.id)
                    .reduce((sum, l) => sum + l.value, 0);
            });
            
            // Generate Layer 1 -> Layer 2 links
            layer1.forEach(sourceNode => {
                const sourceValue = layer1Totals[sourceNode.id];
                let remainingValue = sourceValue;
                
                layer2.forEach((targetNode, targetIndex) => {
                    // Different conversion patterns for different outcomes
                    let proportion;
                    if (targetNode.name.includes('Complete') || targetNode.name.includes('Purchase') || 
                        targetNode.name.includes('Enrolled') || targetNode.name.includes('Approved') ||
                        targetNode.name.includes('Qualified') || targetNode.name.includes('Subscribed')) {
                        proportion = 0.15 + Math.random() * 0.25; // 15-40% for positive outcomes
                    } else if (targetNode.name.includes('Exit') || targetNode.name.includes('Churned') ||
                              targetNode.name.includes('Declined') || targetNode.name.includes('Bounced') ||
                              targetNode.name.includes('Without') || targetNode.name.includes('Withdrawn')) {
                        proportion = 0.3 + Math.random() * 0.4; // 30-70% for negative outcomes
                    } else {
                        proportion = 0.1 + Math.random() * 0.3; // 10-40% for neutral outcomes
                    }
                    
                    let linkValue;
                    if (targetIndex === layer2.length - 1) {
                        linkValue = Math.max(5, remainingValue);
                    } else {
                        linkValue = Math.round(remainingValue * proportion);
                        remainingValue -= linkValue;
                    }
                    
                    if (linkValue > 0) {
                        links.push({
                            source: sourceNode.id,
                            target: targetNode.id,
                            value: linkValue
                        });
                    }
                });
            });
            
            return links;
        }
        
        // Function to update the page with random context
        function generateRandomContext() {
            const contextKeys = Object.keys(contextTemplates);
            const randomKey = contextKeys[Math.floor(Math.random() * contextKeys.length)];
            const selectedContext = contextTemplates[randomKey];
            
            console.log('ðŸŽ² Generated context:', selectedContext.name);
            
            // Update the context info display
            document.getElementById('context-name').textContent = selectedContext.name;
            
            // Generate links for this context
            const links = generateLinks(selectedContext.nodes, selectedContext.baseVolumes);
            
            // Create the complete data structure
            const sankeyData = {
                nodes: selectedContext.nodes,
                links: links
            };
            
            console.log('ðŸ“Š Generated Sankey data:', sankeyData);
            console.log('ðŸ“Š Total volume:', links.reduce((sum, l) => sum + l.value, 0).toLocaleString());
            
            // Update the JSON in the script tag
            const scriptTag = document.getElementById('sankey-data');
            scriptTag.textContent = JSON.stringify(sankeyData, null, 2);
            
            return sankeyData;
        }
        
        // Generate initial random context when page loads
        let currentData = generateRandomContext();
        
        // Regenerate context every time the page is refreshed or focused
        window.addEventListener('focus', () => {
            console.log('ðŸ”„ Page focused, generating new context...');
            currentData = generateRandomContext();
        });
        
        // Add a button to manually generate new context
        function addRegenerateButton() {
            const button = document.createElement('button');
            button.textContent = 'ðŸŽ² Generate New Context';
            button.style.cssText = `
                background: #007acc;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin: 10px 0;
            `;
            button.addEventListener('click', () => {
                generateRandomContext();
            });
            
            const contextInfo = document.getElementById('current-context-info');
            contextInfo.appendChild(button);
        }
        
        // Add the button after page loads
        document.addEventListener('DOMContentLoaded', addRegenerateButton);
        
        console.log('âœ… Test page loaded with dynamic Sankey data');
        console.log('ðŸ“Š JSON data available:', !!document.getElementById('sankey-data'));
        console.log('ðŸ“‹ Table data available:', document.querySelectorAll('table[data-sankey-layer]').length, 'tables');
        console.log('ðŸŽ¯ Current context:', document.getElementById('context-name').textContent);
    </script>
</body>
</html>
